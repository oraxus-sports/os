name: Deploy All Microfrontends to AWS

on:
  push:
    branches: [main, develop]
    paths:
      - 'ui-plugins/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: us-east-1
  STACK_NAME: ${{ github.ref == 'refs/heads/main' && 'sports-os-mfe-production' || 'sports-os-mfe-staging' }}

jobs:
  get-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      components-bucket: ${{ steps.get-outputs.outputs.components-bucket }}
      auth-bucket: ${{ steps.get-outputs.outputs.auth-bucket }}
      platform-bucket: ${{ steps.get-outputs.outputs.platform-bucket }}
      distribution-id: ${{ steps.get-outputs.outputs.distribution-id }}
      components-url: ${{ steps.get-outputs.outputs.components-url }}
      auth-url: ${{ steps.get-outputs.outputs.auth-url }}
      platform-url: ${{ steps.get-outputs.outputs.platform-url }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get CloudFormation outputs
        id: get-outputs
        run: |
          echo "components-bucket=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`ComponentsBucketName`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "auth-bucket=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`AuthBucketName`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "platform-bucket=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`PlatformBucketName`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "distribution-id=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`DistributionId`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "components-url=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`ComponentsURL`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "auth-url=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`AuthURL`].OutputValue' --output text)" >> $GITHUB_OUTPUT
          echo "platform-url=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`PlatformURL`].OutputValue' --output text)" >> $GITHUB_OUTPUT

  # Deploy remotes first (components and auth)
  deploy-components:
    needs: get-infrastructure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ui-plugins/components/package-lock.json
      
      - name: Install dependencies
        working-directory: ./ui-plugins/components
        run: npm ci
      
      - name: Build
        working-directory: ./ui-plugins/components
        env:
          PUBLIC_PATH: ${{ needs.get-infrastructure.outputs.components-url }}/
        run: npm run build
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy to S3
        working-directory: ./ui-plugins/components/dist
        run: |
          aws s3 sync . s3://${{ needs.get-infrastructure.outputs.components-bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "remoteEntry.js"
          
          aws s3 cp remoteEntry.js s3://${{ needs.get-infrastructure.outputs.components-bucket }}/remoteEntry.js \
            --cache-control "public, max-age=300" \
            --content-type "application/javascript"

  deploy-auth:
    needs: get-infrastructure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ui-plugins/auth/package-lock.json
      
      - name: Install dependencies
        working-directory: ./ui-plugins/auth
        run: npm ci
      
      - name: Build
        working-directory: ./ui-plugins/auth
        env:
          PUBLIC_PATH: ${{ needs.get-infrastructure.outputs.auth-url }}/
        run: npm run build
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy to S3
        working-directory: ./ui-plugins/auth/dist
        run: |
          aws s3 sync . s3://${{ needs.get-infrastructure.outputs.auth-bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "remoteEntry.js"
          
          aws s3 cp remoteEntry.js s3://${{ needs.get-infrastructure.outputs.auth-bucket }}/remoteEntry.js \
            --cache-control "public, max-age=300" \
            --content-type "application/javascript"

  # Deploy host last, after remotes are done
  deploy-platform:
    needs: [get-infrastructure, deploy-components, deploy-auth]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ui-plugins/platform/package-lock.json
      
      - name: Install dependencies
        working-directory: ./ui-plugins/platform
        run: npm ci
      
      - name: Build
        working-directory: ./ui-plugins/platform
        env:
          COMPONENTS_URL: ${{ needs.get-infrastructure.outputs.components-url }}
          AUTH_URL: ${{ needs.get-infrastructure.outputs.auth-url }}
          PUBLIC_PATH: ${{ needs.get-infrastructure.outputs.platform-url }}/
        run: npm run build
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy to S3
        working-directory: ./ui-plugins/platform/dist
        run: |
          aws s3 sync . s3://${{ needs.get-infrastructure.outputs.platform-bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html"
          
          aws s3 cp index.html s3://${{ needs.get-infrastructure.outputs.platform-bucket }}/index.html \
            --cache-control "no-cache" \
            --content-type "text/html"
      
      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.get-infrastructure.outputs.distribution-id }} \
            --paths "/*"
      
      - name: Deployment summary
        run: |
          echo "### âœ… Full Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform URL**: ${{ needs.get-infrastructure.outputs.platform-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Components URL**: ${{ needs.get-infrastructure.outputs.components-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auth URL**: ${{ needs.get-infrastructure.outputs.auth-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront**: Invalidation in progress (5-10 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Your application will be available shortly!" >> $GITHUB_STEP_SUMMARY
